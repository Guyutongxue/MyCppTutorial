# 需要注意的 C 特性

?> [TODO] 详细解释

## 独有特性

首先列举 C 中特有而 C++ 中没有的语法。

### 从 `void*` 到其它指针类型的隐式转换

在 C++ 中，允许从任意指针类型 `T*` 到 `void*` 的隐式转换，但反过来不行。但是 C 中允许双向的转换。这使得以下代码
```c
// 申请 sizeof(int) 这么多字节的内存，并将其地址初始化于 p
int* p = malloc(sizeof(int));
```
得以正确编译。因为 `malloc` 是返回 `void*` 的函数，然后 `void*` 可以隐式转换到 `int*`。如果在 C++ 中，你需要加上显式转换才能编译通过：
```cpp
int* p = (int*)malloc(sizeof(int));
```

### 从 `int` 到枚举类型的隐式转换

?> [TODO] 枚举类型

C++ 中允许从枚举类型到其基类型（一般是 `int`）的隐式转换，但反过来不行。C 则允许双向的转换：
```c
enum Color {
    Red,
    Green,
    Blue
};
int a = Red; // C/C++ 都合法
enum Color b = 1; // C 合法，C++ 错误
```

### 无初始化器的只读变量

在 C 中，只读变量可以没有初始化器，然而在 C++ 中这是不允许的。
```c
const int a; // 无初始化器：C 允许，C++ 错误
```

### 跨越声明语句的 goto 语句

在 C 中，goto 语句可以跳过带初始化器的声明语句，但在 C++ 中不允许。
```c
goto line; // C 允许，C++ 错误
{
    int a = 42;
    line: printf("%d", a);
}
```
### 旧式（K&R 风格）函数定义

在 C 中，函数参数的类型可以和函数的声明分离开来：
```c
int max(a, b)
    int a;
    int b;
    {
    return a > b ? a : b;
}
```
这被称为旧式函数定义，它等价于这样的新式函数定义：
```c
int max(int a, int b) {
    return a > b ? a : b;
}
```

旧式函数定义是一种不再被推荐的写法，而且即将被弃用。你只可能在一些很老的代码里见到这种写法，了解即可。

以下介绍的特性都是 C99 标准引入的，它们可能不在老编译器上支持。

### 可变长数组（C99）

不同于 C++，C 在声明数组时允许它的大小不是常量（前提是该数组拥有自动存储期）：
```c
int n;
scanf("%d", &n);
int a[n]; // 大小不是常量，C OK 但 C++ 不允许
```

- 柔性数组
- `restrict` 关键字
- 额外数组形参语法
- 复合字面量
- 指派初始化器
- 在函数声明中定义结构体
- `_Generic` 泛型选择
- `_Atomic` 原子类型（C++ 中 `std::atomic`）
- 原生复数运算支持（C++ 中 `std::complex`）

## 不同特性

- 无参函数需显式指明 `void` （C++ 中不需要）
- 字符字面量为 `int` 类型（C++ 中 `char`）
- 字符串字面量为 `char[N]` 类型（C++ 中 `const char[N]`）
- 循环或分支的条件只能为表达式（C++ 中允许声明）
- 循环或分支的条件均隐式转换为 `int` （C++ 中为 `bool`）
- 结构体详述类型说明符必须给出（C++ 中可省略）
- 结构体不引入作用域（C++ 中引入）
- 关键字 `inline` 含义为优先内联（C++ 中为容许重复定义）
- 全局作用域只读变量拥有外部链接（C++ 中拥有内部链接）
- `_Noreturn`（C++ 中 `[[noreturn]]`）
- 布尔类型类型说明符为 `_Bool`（C++ 中 `bool`）
- 对齐相关关键字 `_Alignas` `_Alignof`（C++ 中 `alignas` `alignof`）
- 静态断言 `_Static_assert`（C++ 中 `static_assert`）
- 线程存储期 `_Thread_local`（C++ 中 `thread_local`）

### C99 前

- 无单行注释（现有）
- 隐式函数声明（现被弃用）
- 全局 `int` 类型说明符可省略（现必需）
- main 函数中 `return 0;` 必需（现可选）
- for 循环初始语句只能为表达式（现允许声明）
- 复合语句中声明必须出现在开头（现允许任意位置）